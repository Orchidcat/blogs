<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="何柳">
  <meta name="description" content="Posts and writings by 何柳">

  <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="He Liu's Personal Website Atom" />

<meta name="keywords" content="">

  <title>
    He Liu's Personal Website
&ndash; python 抓包样例  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="">
        <img src="/theme/images/logo.png" alt="logo">
      </a>
      <h2><a href="">He Liu's Personal Website</a></h2>
      <p></p>
      <ul>
        <li><a href="/category/mssql.html">MSSQL</a></li>
        <li><a href="/category/oracle.html">Oracle</a></li>
        <li><a href="/category/python.html">Python</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="">Index</a> &brvbar; <a href="/archives.html">Archives</a>
      &brvbar; <a href="/feeds/all.atom.xml">Atom</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="/blog/2019/11/get-python-demo/">python 抓包样例</a></h1>
  </div>
  <div class="article_text">
    <p>python抓包样例</p>
<div class="highlight"><pre><span></span>    <span class="k">SELECT</span>  <span class="err">编号</span> <span class="p">,</span>        
            <span class="err">部门</span> <span class="p">,</span>        
            <span class="err">金额</span> <span class="p">,</span>        
            <span class="err">审批结束时间</span> <span class="p">,</span>        
            <span class="err">主旨</span> <span class="p">,</span>        
            <span class="err">审批编号</span> <span class="p">,</span>        
            <span class="n">deadline_date</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">-</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="err">审批结束时间</span><span class="p">,</span> <span class="n">GETDATE</span><span class="p">())</span>        
    <span class="k">FROM</span>    <span class="p">(</span> <span class="k">SELECT</span>    <span class="err">裁决号</span> <span class="k">AS</span> <span class="err">编号</span> <span class="p">,</span>        
                        <span class="err">起案部门</span> <span class="k">AS</span> <span class="err">部门</span> <span class="p">,</span>        
                        <span class="err">金额</span> <span class="p">,</span>        
                        <span class="err">审批结束时间</span> <span class="p">,</span>        
                        <span class="err">主旨</span> <span class="p">,</span>        
                        <span class="err">编号</span> <span class="k">AS</span> <span class="err">审批编号</span>        
              <span class="k">FROM</span>      <span class="p">[</span><span class="mi">10</span><span class="p">.</span><span class="mi">116</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">21</span><span class="p">].</span><span class="n">SMC_OA</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">V_V5_301</span><span class="err">禀议书</span> <span class="p">)</span><span class="n">T</span>   
</pre></div>


<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding:utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">import</span> <span class="nn">request</span>
<span class="kn">from</span> <span class="nn">selenium.webdriver.common.action_chains</span> <span class="kn">import</span> <span class="n">ActionChains</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">brower</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="s1">&#39;C:\chromedriver.exe&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">loadpage</span><span class="p">(</span><span class="n">userid</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="c1"># url = &quot;https://passport.jd.com/new/login.aspx?&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://order.jd.com/center/list.action&quot;</span>
    <span class="n">brower</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;//div/div[@class=&quot;login-tab login-tab-r&quot;]/a&#39;</span>
    <span class="n">userlogin</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
    <span class="n">userlogin</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="c1"># time.sleep(5)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s2">&quot;loginname&quot;</span><span class="p">)</span>
    <span class="n">username</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">userid</span><span class="p">)</span>
    <span class="n">userpswd</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s2">&quot;nloginpwd&quot;</span><span class="p">)</span>
    <span class="n">userpswd</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="c1"># time.sleep(5)</span>
    <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s2">&quot;loginsubmit&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


    <span class="n">ff</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;D:\data.txt&#39;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">getPic</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>

            <span class="c1"># print(brower.current_url)</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s2">&quot;tbody&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">):</span>
                  <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">get_property</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;tb-&#39;</span><span class="p">,</span><span class="s1">&#39;JD&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;parent-&#39;</span><span class="p">,</span><span class="s1">&#39;拆单-&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="s2">&quot;.//div[@class=&#39;consignee tooltip&#39;]/span&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">50</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">ff</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">break</span>


<span class="k">def</span> <span class="nf">getPic</span><span class="p">():</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;//div/div[@class=&quot;JDJRV-bigimg&quot;]/img&#39;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;//div/div[@class=&quot;JDJRV-smallimg&quot;]/img&#39;</span>
    <span class="n">bigimg</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
    <span class="n">smallimg</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">smallimg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">bigimg</span><span class="p">)</span>

    <span class="n">backimg</span> <span class="o">=</span> <span class="s2">&quot;backimg.png&quot;</span>
    <span class="n">slideimg</span> <span class="o">=</span> <span class="s2">&quot;slideimg.png&quot;</span>

    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">bigimg</span><span class="p">,</span> <span class="n">backimg</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">smallimg</span><span class="p">,</span> <span class="n">slideimg</span><span class="p">)</span>

    <span class="n">block</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">slideimg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">backimg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">blockName</span> <span class="o">=</span> <span class="s2">&quot;block.jpg&quot;</span>
    <span class="n">templateName</span> <span class="o">=</span> <span class="s2">&quot;template.jpg&quot;</span>

    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">blockName</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">templateName</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">blockName</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">255</span> <span class="o">-</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">blockName</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">blockName</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">templateName</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCOEFF_NORMED</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">element</span> <span class="o">=</span> <span class="n">brower</span><span class="o">.</span><span class="n">find_element_by_xpath</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
    <span class="n">ActionChains</span><span class="p">(</span><span class="n">brower</span><span class="p">)</span><span class="o">.</span><span class="n">click_and_hold</span><span class="p">(</span><span class="n">on_element</span><span class="o">=</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
    <span class="n">ActionChains</span><span class="p">(</span><span class="n">brower</span><span class="p">)</span><span class="o">.</span><span class="n">move_to_element_with_offset</span><span class="p">(</span><span class="n">to_element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span> <span class="n">xoffset</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">yoffset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
    <span class="n">ActionChains</span><span class="p">(</span><span class="n">brower</span><span class="p">)</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">on_element</span><span class="o">=</span><span class="n">element</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">defaultencoding</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span> <span class="o">!=</span> <span class="n">defaultencoding</span><span class="p">:</span>
        <span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="s2">&quot;smc中国&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="n">passwd</span> <span class="o">=</span> <span class="s2">&quot;P0O9I8U7&quot;</span>
    <span class="n">loadpage</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">passwd</span><span class="p">)</span>
</pre></div>
  </div>
  <div class="article_meta">
    <p>Posted on: 2019-11-18</p>
    <p>Category: <a href="/category/python.html">Python</a>
    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; 何柳. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>